# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## About This Project

This is a swimming competition management system called "TEN - Gestión de Competencias". It's a Streamlit web application that processes swimming competition data, generates seeding arrangements, and produces results reports with scoring systems.

## How to Run the Application

```bash
streamlit run app.py
```

The application will start a web interface accessible at `http://localhost:8501`.

## Core Architecture

### Main Application (`app.py`)
- Streamlit web interface with multiple functional modules
- Imports and integrates three core processing scripts as modules
- Uses custom CSS styling with blue gradient theme matching TEN logo
- File upload/download functionality for Excel files
- Multi-page interface with sidebar navigation

### Core Processing Modules

0. **`event_manager.py`** - Event configuration management
   - Manages event creation, configuration, and storage
   - Allows selection of available swimming events for competitions
   - Defines age ranges and event-specific settings
   - Integrates with registration system to filter available events
   - Outputs: `event_config.json`

1. **`generar_sembrado.py`** - Category-based seeding
   - Groups swimmers by age category, then sorts by time within each category
   - Places fastest swimmers in final heats (swimming competition standard)
   - Respects event configuration for available events
   - Outputs: `sembrado_competencia.xlsx`

2. **`generar_sembrado_por_tiempo.py`** - Time-based seeding
   - Sorts all swimmers purely by registration time, ignoring categories
   - Used for open competitions or qualifying events
   - Respects event configuration for available events
   - Outputs: `sembrado_competencia_POR_TIEMPO.xlsx`

3. **`generar_papeletas.py`** - Judge scoresheets generation
   - Creates PDF scoresheets for judges with lane assignments, series, and events
   - Includes blank spaces for recording race times during competition
   - Professional format with headers, swimmer details, and competition info
   - Outputs: `papeletas_jueces.pdf`

4. **`procesar_resultados.py`** - Results processing and scoring
   - Reads final race times and calculates rankings
   - Applies point system: 1st=9pts, 2nd=7pts, 3rd=6pts, 4th=5pts, 5th=4pts, 6th=3pts, 7th=2pts, 8th=1pt
   - Generates three reports: by event/category, individual rankings, team rankings
   - Outputs: `reporte_premiacion_final_CORREGIDO.xlsx`

5. **`1-inscripcion_nadadores.py`** - Swimmer registration system
   - Complete registration interface with manual and database search methods
   - Database integration with `BASE-DE-DATOS.xlsx` (FPROYECCION 2025T and M. PROYECCION 2025 sheets)
   - Duplicate validation with override options
   - PDF report generation with company logo
   - Event mapping and time validation

## Required Input Files

- **`event_config.json`** - Event configuration file (generated by event creation module)
  - Contains event name, selected swimming events, age ranges
  - Automatically created when setting up a new competition event
- **`planilla_inscripcion.xlsx`** - Registration data with swimmer info and event entries
  - Expected columns: 'NOMBRE Y AP', 'EQUIPO', 'EDAD', 'CAT.', 'SEXO', plus event columns with times
  - Column structure adapts to events selected in event configuration
- **`resultados_con_tiempos.xlsx`** - Final race results (needed for results processing only)
  - Structured format with race times by event and category
- **`BASE-DE-DATOS.xlsx`** - Swimmer database (needed for registration only)
  - Contains FPROYECCION 2025T sheet (female swimmers) and M. PROYECCION 2025 sheet (male swimmers)
  - Expected columns: ATLETA, EQUIPO, CATEGORIA, SEXO, EDAD, PRUEBA, TIEMPO, F. COMPETENCIA
  - System automatically combines both sheets for comprehensive athlete search
  - Database search is filtered by events selected in event configuration

## Key Data Processing Logic

### Time Parsing (`parse_time` function)
- Handles multiple time formats: MM:SS.ff, pandas datetime objects, plain seconds
- Returns time in seconds as float for sorting
- Invalid times return `float('inf')` to sort last

### Lane Assignment (`seed_series` function)  
- Uses standard swimming lane order: [4, 5, 3, 6, 2, 7, 1, 8] for 8-lane pools
- Fastest swimmers get center lanes in final heats
- Configurable pool lanes (default: 8)

### Results Processing
- Groups results by event and category for fair competition
- Handles both men's and women's events separately
- Automatic ranking calculation with proper tie handling

## File Structure

```
/
├── app.py                    # Main Streamlit application
├── event_manager.py          # Event configuration management
├── 1-inscripcion_nadadores.py  # Swimmer registration system
├── 2-generar_sembrado.py     # Category-based seeding (renamed)
├── 3-generar_sembrado_por_tiempo.py  # Time-based seeding (renamed)
├── 4-procesar_resultados.py  # Results processing (renamed)
├── generar_papeletas.py      # Judge scoresheets PDF generation
├── img/TEN.png              # Organization logo
├── requirements.txt         # Python dependencies
├── event_config.json        # Event configuration file (generated)
├── *.xlsx                   # Input/output Excel files
└── CLAUDE.md                # This file
```

## Dependencies

- `streamlit` - Web interface
- `pandas` - Excel file processing and data manipulation
- `openpyxl` - Excel file creation with formatting
- `reportlab` - PDF report generation
- `pathlib` - File path handling

Install all dependencies using:
```bash
pip install -r requirements.txt
```

### Troubleshooting ReportLab Installation

If you encounter issues with PDF generation, ReportLab might not be installed in your Python environment. Try these solutions:

1. **Install ReportLab manually:**
   ```bash
   pip install reportlab
   # or
   pip3 install reportlab
   # or
   python -m pip install reportlab
   # or  
   python3 -m pip install reportlab
   ```

2. **If using virtual environment:**
   ```bash
   # Activate your virtual environment first
   source venv/bin/activate  # Linux/Mac
   # or
   venv\Scripts\activate     # Windows
   
   # Then install
   pip install reportlab
   ```

3. **Restart Streamlit after installation:**
   ```bash
   streamlit run app.py
   ```

## New Features

### Event Management System
The system now includes comprehensive event configuration management:

1. **Event Creation Interface**: Web-based interface for setting up competition events
2. **Event Configuration**: Define event name, age ranges, and available swimming events
3. **Event Selection**: Checkbox-based selection of swimming events for the competition
4. **Event Persistence**: Configuration saved in JSON format for session persistence
5. **Event Integration**: All modules respect event configuration for filtering and processing

### Event Management Features
- **Flexible Event Setup**: Choose from 15 standard swimming events
- **Age Range Configuration**: Set minimum and maximum ages for participants
- **Event Filtering**: Registration and database search limited to selected events only
- **Event Modification**: Update existing event configurations
- **Event Validation**: Ensures at least one event is selected and age ranges are valid

### Registration System Integration

### Swimmer Registration Interface
The registration system (`1-inscripcion_nadadores.py`) includes:

1. **Manual Registration**: Complete form interface for swimmer data entry
2. **Database Search**: Automatic lookup in swimmer database with historical times
3. **Duplicate Detection**: Validates against existing registrations with override options
4. **Edit Functionality**: Modify existing swimmer registrations
5. **PDF Reports**: Generate professional reports with company logo and statistics
6. **Enhanced Analytics**: Comprehensive statistics including gender and event distributions

### Registration Features
- **Dual input methods**: Manual entry or database search
- **Time validation**: Ensures proper time formats (MM:SS.ff)
- **Category assignment**: Automatic age-based category calculation
- **Event management**: Full swimming event support (15 events)
- **Duplicate alerts**: Smart detection with detailed conflict information

### Statistics and Reports
- **Gender distribution**: Male/Female breakdown with percentages
- **Event popularity**: Bar charts and top 5 events
- **Team analytics**: Distribution by swimming clubs
- **PDF generation**: Professional reports with TEN logo and branding

## Development Notes

- All processing functions can run independently as scripts or be imported as modules
- Excel files use openpyxl for advanced formatting (fonts, borders, column widths)
- The application includes comprehensive error handling and user feedback
- File operations include safety checks for required input files
- Registration system integrates seamlessly with existing seeding and results modules
- PDF generation requires ReportLab library (included in requirements.txt)
- Judge scoresheets system creates professional PDF forms for competition time recording

## Judge Scoresheets Feature

### Overview
The system now includes automatic generation of PDF scoresheets for judges after generating the seeding. These papeletas provide:

- **Lane assignments**: Each swimmer's assigned lane clearly displayed
- **Series information**: Heat/series numbers for each race  
- **Event details**: Event name, category, and gender division
- **Time recording spaces**: Blank fields for judges to write competition times
- **Professional layout**: Formatted tables with swimmer details (name, team)

### Usage Workflow
1. **Generate seeding** (by category or time) in the main application
2. **Click "Generar Papeletas PDF"** button that appears after successful seeding
3. **Download the PDF file** (`papeletas_jueces.pdf`) 
4. **Print the scoresheets** and distribute to judges during competition
5. **Record times** in the blank spaces provided during races
6. **Input recorded times** back into the system for results processing

### Technical Details
- **PDF format**: Landscape A4 orientation for better readability
- **One sheet per series**: Each heat gets its own dedicated page
- **Standard lane layout**: Uses swimming competition standard (lanes 4,5,3,6,2,7,1,8)
- **Error handling**: Validates required files and provides clear error messages